{% extends "layout.html" %}
{% from 'utils.html' import form_tag, render_form_fields %}
{% from 'bootstrap4/nav.html' import render_breadcrumb_item %}
{% from 'bootstrap4/utils.html' import render_icon %}

{% block title %}{% if is_new %}
  {{ _("Add command") }}
{% else %}
  {{ _("Edit command") }}
{% endif %}
{% endblock %}

{% block breadcrumb %}
  {% if is_new %}
    {{ render_breadcrumb_item('commands_list', _('Commands')) }}
    {{ render_breadcrumb_item('commands_edit', _('New')) }}
  {% else %}
    {{ render_breadcrumb_item('commands_list', _('Commands')) }}
    {{ render_breadcrumb_item('commands_show', command.name, command_id=command.id) }}
    {{ render_breadcrumb_item('commands_edit', _("Edit"), command_id=command.id) }}
    <li class="dropdown ml-auto">
      <a href="#" class="dropdown-toggle text-decoration-none" data-toggle="dropdown" title="{{ gettext("Export...") }}">
        {{ render_icon("download") }}<span class="caret ml-0"></span>
      </a>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
        <a class="dropdown-item" href="{{ url_for('commands_show', command_id=command.id, export='json') }}">JSON</a>
        <a class="dropdown-item" href="{{ url_for('commands_show', command_id=command.id, export='csv') }}">CSV</a>
        <a class="dropdown-item" href="{{ url_for('commands_show', command_id=command.id, export='xls') }}">XLS</a>
      </div>
    </li>
    <li class="ml-2"><a href="{{ url_for('commands_show', command_id=command.id) }}" title="{{ gettext("Show") }}">{{ render_icon("eye") }}</a></li>
    <li class="ml-2"><a href="{{ url_for('commands_logs', command_id=command.id) }}" title="{{ gettext("Logs") }}">{{ render_icon("clock-history") }}</a></li>
    <li class="ml-2"><a href="{{ url_for('commands_run', command_id=command.id) }}" class="post_link" title="{{ gettext("Run") }}">{{ render_icon("play") }}</a></li>
    <li class="ml-2"><a href="{{ url_for('commands_delete', command_id=command.id) }}" class="post_link" title="{{ gettext("Delete") }}">{{ render_icon("trash") }}</a></li>
    <li class="ml-2"><a href="{{ url_for('commands_edit') }}" title="{{ gettext("New") }}">{{ render_icon("plus") }}</a></li>
  {% endif %}
{% endblock %}

{% block body %}

  <div id="form_global_errors">
    <div class="alert alert-warning d-none warning-template" role="alert">
      Default text.
    </div>
  </div>

  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="general-tab" data-toggle="tab" data-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">{{ _("General") }}</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="run-tab" data-toggle="tab" data-target="#run" type="button" role="tab" aria-controls="run" aria-selected="true">{{ _("Run") }}</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="schedule-tab" data-toggle="tab" data-target="#schedule" type="button" role="tab" aria-controls="schedule" aria-selected="false">{{ _("Schedule") }}</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="options-tab" data-toggle="tab" data-target="#options" type="button" role="tab" aria-controls="options" aria-selected="false">{{ _("Options") }}</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="environment-tab" data-toggle="tab" data-target="#environment" type="button" role="tab" aria-controls="environment" aria-selected="false">{{ _("Environment") }}</button>
    </li>
  </ul>

  {% call form_tag(
    form,
    id="command_edit_form",
    form_type='horizontal',
    action=url_for('commands_edit', command_id=command.id) if not is_new else url_for('commands_edit'),
    cancel_button_url=url_for('commands_list')) %}

    <div class="tab-content m-3" id="myTabContent">
      <div class="tab-pane active" id="general" role="tabpanel" aria-labelledby="general-tab">
        {{ render_form_fields(form, form_type="horizontal", include_common_fields=True, field_section_filter="general") }}
      </div>
      <div class="tab-pane" id="run" role="tabpanel" aria-labelledby="run-tab">
        {{ render_form_fields(form, form_type="horizontal", include_common_fields=True, field_section_filter="run") }}
      </div>
      <div class="tab-pane" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
        {{ render_form_fields(form, form_type="horizontal", include_common_fields=False, field_section_filter="schedule") }}
      </div>
      <div class="tab-pane" id="options" role="tabpanel" aria-labelledby="options-tab">
        <p>{% trans %}These options override, if set, those set in the general settings.{% endtrans %}</p>
        {{ render_form_fields(form, form_type="horizontal", include_common_fields=False, field_section_filter="options") }}
      </div>
      <div class="tab-pane" id="environment" role="tabpanel" aria-labelledby="environment-tab">
        {{ render_form_fields(form, form_type="horizontal", include_common_fields=False, field_section_filter="environment") }}
      </div>
    </div>

  {% endcall %}

{% endblock %}

{% block customscripts %}
  <script>
    $(document).ready(function () {

      // Focus
      $("#id").focus();

      $("#run_mode").on("change", function () {
        $("#command").closest("div.form-group").hide();
        $("#script").closest("div.form-group").hide();
        $("#script_interpreter").closest("div.form-group").hide();
        const run_mode = $("#run_mode").val();
        if (run_mode === "COMMAND") {
          $("#command").closest("div.form-group").show();
        } else if (run_mode === "SCRIPT") {
          $("#script").closest("div.form-group").show();
          $("#script_interpreter").closest("div.form-group").show();
        }
      }).trigger("change");

      $("#schedule_mode").on("change", function () {
        $("#period_seconds").closest("div.form-group").hide();
        $("#cron_expr").closest("div.form-group").hide();
        $("#run_at_startup").closest("div.form-group").hide();
        $("#run_at_startup_if_missing_previous_run").closest("div.form-group").hide();
        const schedule_mode = $("#schedule_mode").val();
        if (schedule_mode === "PERIOD") {
          $("#period_seconds").closest("div.form-group").show();
          $("#run_at_startup").closest("div.form-group").show();
          $("#run_at_startup_if_missing_previous_run").closest("div.form-group").show();
        } else if (schedule_mode === "CRON") {
          $("#cron_expr").closest("div.form-group").show();
          $("#run_at_startup").closest("div.form-group").show();
          $("#run_at_startup_if_missing_previous_run").closest("div.form-group").show();
        }
      }).trigger("change");

      enable_form_server_side_validation($("#command_edit_form"), {{ (url_for("commands_edit", command_id=command.id, validate="1") if not is_new else url_for("commands_edit", validate="1")) | tojson }});

    });
  </script>
{% endblock %}
